<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Interactive Space Sphere</title>
<style>
  body {
    margin: 0;
    overflow: hidden;
    background: radial-gradient(circle at center, #050510 0%, #000000 70%);
  }
</style>
</head>
<body>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

<script>
const scene = new THREE.Scene();

// ===== دوربین adaptive =====
const camera = new THREE.PerspectiveCamera(
  95, // FOV کمی بازتر برای موبایل و دسکتاپ
  window.innerWidth / window.innerHeight,
  0.1,
  1000
);

const isMobile = window.innerWidth < 768;
camera.position.z = isMobile ? 4 : 3;

// ===== رندر =====
const renderer = new THREE.WebGLRenderer({ antialias: true });
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);

// ===== ستاره‌ها =====
const starCount = 2000;
const starPositions = [];
for (let i=0; i<starCount; i++){
  const x = (Math.random()-0.5)*200;
  const y = (Math.random()-0.5)*200;
  const z = (Math.random()-0.5)*200;
  starPositions.push(x,y,z);
}
const starsGeometry = new THREE.BufferGeometry();
starsGeometry.setAttribute('position', new THREE.Float32BufferAttribute(starPositions,3));
const starsMaterial = new THREE.PointsMaterial({ color: 0xffffff, size: 0.7 });
const stars = new THREE.Points(starsGeometry, starsMaterial);
scene.add(stars);

// ===== کره اصلی =====
const sphereGeometry = new THREE.SphereGeometry(1,64,64);
const count = sphereGeometry.attributes.position.count;

const positions = new Float32Array(count*3);
const randomPositions = new Float32Array(count*3);
const spherePositions = sphereGeometry.attributes.position.array;
const colors = new Float32Array(count*3);

const color = new THREE.Color();

for (let i=0;i<count;i++){
  const ix = i*3;
  randomPositions[ix] = (Math.random()-0.5)*7;
  randomPositions[ix+1] = (Math.random()-0.5)*7;
  randomPositions[ix+2] = (Math.random()-0.5)*7;

  positions[ix] = randomPositions[ix];
  positions[ix+1] = randomPositions[ix+1];
  positions[ix+2] = randomPositions[ix+2];

  const hue = 0.6 + Math.random()*0.15;
  color.setHSL(hue,0.8,0.5);

  colors[ix] = color.r;
  colors[ix+1] = color.g;
  colors[ix+2] = color.b;
}

const geometry = new THREE.BufferGeometry();
geometry.setAttribute('position', new THREE.BufferAttribute(positions,3));
geometry.setAttribute('color', new THREE.BufferAttribute(colors,3));

const material = new THREE.PointsMaterial({
  size:0.05,
  vertexColors:true,
  transparent:true,
  opacity:0.9,
  blending:THREE.AdditiveBlending,
  depthWrite:false
});

const points = new THREE.Points(geometry, material);
scene.add(points);

// ===== حلقه پارتیکل =====
const ringGroup = new THREE.Group();
scene.add(ringGroup);
const ringPointsArr = [];

for(let r=0;r<4;r++){
  const baseRing = new THREE.RingGeometry(1.5+r*0.12,1.6+r*0.12,128);
  const ringGeo = new THREE.BufferGeometry();
  ringGeo.setAttribute('position', new THREE.BufferAttribute(baseRing.attributes.position.array,3));

  const ringMat = new THREE.PointsMaterial({
    size:0.04,
    color:0xffcc88,
    transparent:true,
    opacity:0.6,
    blending:THREE.AdditiveBlending,
    depthWrite:false
  });

  const ringPoints = new THREE.Points(ringGeo, ringMat);
  ringPoints.rotation.x = Math.PI/2.3;
  ringGroup.add(ringPoints);
  ringPointsArr.push({mesh:ringPoints, geo:ringGeo});
}

// ===== کنترل Morph و موس/تاچ =====
let morph = 0;
let targetMorph = 0;
let mouseX=0, mouseY=0;
let targetRotationX=0, targetRotationY=0;

function setMouseRotation(xNorm,yNorm){
  targetRotationY = xNorm*1.5;
  targetRotationX = yNorm*1.5;
}

// موس
window.addEventListener("mousemove", e=>{
  setMouseRotation((e.clientX/window.innerWidth)*2-1,(e.clientY/window.innerHeight)*2-1);
});

// تاچ
window.addEventListener("touchmove", e=>{
  if(e.touches.length==1){
    const t = e.touches[0];
    setMouseRotation((t.clientX/window.innerWidth)*2-1,(t.clientY/window.innerHeight)*2-1);
  }
});

// کلیک یا تاچ نگه دار
function startMorph(){ targetMorph=1; }
function stopMorph(){ targetMorph=0; }
window.addEventListener("mousedown", startMorph);
window.addEventListener("mouseup", stopMorph);
window.addEventListener("touchstart", startMorph);
window.addEventListener("touchend", stopMorph);

// ===== انیمیشن =====
function animate(){
  requestAnimationFrame(animate);

  morph += (targetMorph-morph)*0.05;

  const posArray = geometry.attributes.position.array;
  for(let i=0;i<count;i++){
    const ix=i*3;
    const scale = 1+morph*0.6;
    posArray[ix] = randomPositions[ix]*(1-morph)+spherePositions[ix]*morph*scale;
    posArray[ix+1] = randomPositions[ix+1]*(1-morph)+spherePositions[ix+1]*morph*scale;
    posArray[ix+2] = randomPositions[ix+2]*(1-morph)+spherePositions[ix+2]*morph*scale;
  }
  geometry.attributes.position.needsUpdate=true;

  // حلقه‌ها چرخش نرم
  ringPointsArr.forEach(r=>{
    r.mesh.rotation.y += 0.002; // کمی کندتر
  });

  // چرخش موس
  points.rotation.y += (targetRotationY-points.rotation.y)*0.05;
  points.rotation.x += (targetRotationX-points.rotation.x)*0.05;

  stars.rotation.y += 0.0005;

  renderer.render(scene,camera);
}
animate();

// ===== ریسپانسیو =====
window.addEventListener('resize',()=>{
  camera.aspect = window.innerWidth/window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
});
</script>

<!-- موزیک پس زمینه -->
<audio autoplay loop>
  <source src="background.mp3" type="audio/mpeg">
</audio>

</body>
</html>
